#!/bin/bash

# Build all the configured benchmarks for the provided project
# Expects the first argument to be the path to a project th

set -e

# Get the desired optimization level if specified
if [[ -z "${OPT_LEVEL}" ]]; then
    # Default OPT level
    OPT_LEVEL_ARG="-DOPT_LEVEL=-O1"
else
    OPT_LEVEL_ARG="-DOPT_LEVEL=${OPT_LEVEL}"
fi

#
# Target configurations
#

# Uninstrumented
# This is the plain default configuration
function uninstrumented() {
    export PATH="$LLVM_BIN_ROOT/bin:$PATH"
    export LLVM_COMPILER_PATH="$LLVM_BIN_ROOT/bin"
    export LLVM_CC_NAME=clang-16
}

# ReplayCache
# This it the ReplayCache-specific configuration with a patched LLVM version
function replay-cache() {
    export PATH="$LLVM_RC_ROOT/bin:$PATH"
    export LLVM_COMPILER_PATH="$LLVM_RC_ROOT/bin"
    export LLVM_CC_NAME=clang-16
}


# All regular targets are above
funcs=$(declare -F)
targets="${funcs//declare -f /}"


function help() {
    echo "Usage: benchmark-build [target]"
    echo ""
    echo "targets: (bash functions in this script)"
    echo "${funcs//declare -f/ }"

    # Other
    echo ""
    echo "other:"
    echo "  help       print this help message"
    echo "  targets    print all the available targets"
}

function targets() {
    echo $targets
}


# Build the benchmark using the environment variables set in the targets
CMAKE_TOOLCHAIN_FILE="$ICLANG_ROOT/toolchains/riscv32/toolchain.cmake"
function build_benchmark() {
    local benchmark_name="$1"
    local build_dir="build-$benchmark_name$OPT_LEVEL"
    echo "Building benchmark $benchmark_name in $build_dir with $OPT_LEVEL_ARG"

    # Allow target configuration to apply its changes
    "$benchmark_name" "$benchmark_name"

    cmake $OPT_LEVEL_ARG -DCMAKE_TOOLCHAIN_FILE="$CMAKE_TOOLCHAIN_FILE" -DCMAKE_INTERPROCEDURAL_OPTIMIZATION:BOOL=TRUE -B "$build_dir"
    cmake --build "$build_dir"
}

target="$1"
if [ -z "$1" ]; then
    echo "Please provide a target (bash function)"
    help
    exit 1
fi

# Run the function that generates the target
if [[ $(type -t $target) == function ]]; then
    build_benchmark "$target"
else
    echo "Target '$target' does not exist"
    help
    exit
fi
